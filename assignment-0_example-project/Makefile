#####################################################################
##
## SCCTs makefile - template taken and modified from
## https://gist.github.com/maxtruxa/4b3929e118914ccef057f8a05c614b0f  
##
#####################################################################

# set directories
OBJ_DIR 	:= build/obj
DEP_DIR 	:= build/dep
SOURCE_DIR  := source
BUILD_DIR 	:= build

# set compiler & linker
CC 	:= gcc
LD 	:= gcc

# output binary
TARGET := $(BUILD_DIR)/test


# find our source files (recursively)
SOURCE_FILES := $(wildcard $(SOURCE_DIR)/*.c) 

# files included in the tarball generated by 'make dist' (e.g. add LICENSE file)
DISTFILES := $(TARGET)

# filename of the tar archive generated by 'make dist'
DISTOUTPUT := $(TARGET).tar.gz

# object files, auto generated from source files
OBJ_FILES := $(patsubst %,$(OBJ_DIR)/%.o,$(basename $(SOURCE_FILES)))
# dependency files, auto generated from source files
DEP_FILES := $(patsubst %,$(DEP_DIR)/%.d,$(basename $(SOURCE_FILES)))

# compilers (at least gcc and clang) don't create the subdirectories automatically
$(shell mkdir -p $(dir $(OBJ_FILES)) >/dev/null)
$(shell mkdir -p $(dir $(DEP_FILES)) >/dev/null)

# compiler flags
# -g ... adds debug information to our executable file
# -Wall ... enable most warnings
# -L ... path to the library dir
# -l ... name of the library ot be included
# -pedantic ... learn how to code 
CFLAGS = -g -Wall -Wextra -std=c89 -pedantic

# linker flags
LDFLAGS :=

# flags required for dependency generation; passed to compilers
DEPFLAGS = -MT $@ -MD -MP -MF $(DEP_DIR)/$*.Td

# compile C source files
COMPILE.c = $(CC) $(DEPFLAGS) $(CFLAGS) $(CPPFLAGS) -c -o $@

# link object files to binary
LINK.o = $(LD) $(LDFLAGS) $(LDLIBS) -o $@
# precompile step
PRECOMPILE =

# postcompile step
POSTCOMPILE = mv -f $(DEP_DIR)/$*.Td $(DEP_DIR)/$*.d

all: $(TARGET)

dist: $(DISTFILES)
	$(TAR) -cvzf $(DISTOUTPUT) $^

.PHONY: clean
clean:
	$(RM) -r $(OBJ_DIR) $(DEP_DIR)

.PHONY: distclean
distclean: clean
	$(RM) $(TARGET) $(DISTOUTPUT)

.PHONY: test
test:
	@echo running binary:
	$(TARGET)

.PHONY: install
install:
	@echo no install tasks configured

.PHONY: uninstall
uninstall:
	@echo no uninstall tasks configured

.PHONY: check
check:
	@echo no tests configured

.PHONY: help
help:
	@echo available targets: all dist clean distclean test install uninstall check

$(TARGET): $(OBJ_FILES)
	$(LINK.o) $^

$(OBJ_DIR)/%.o: %.c
$(OBJ_DIR)/%.o: %.c $(DEP_DIR)/%.d
	$(PRECOMPILE)
	$(COMPILE.c) $<
	$(POSTCOMPILE)

.PRECIOUS = $(DEP_DIR)/%.d
$(DEP_DIR)/%.d: ;

-include $(DEP_FILES)
